---
name: Release

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-24.04
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"

      - name: Install semantic-release and plugins
        run: |
          npm install -g \
            semantic-release \
            @semantic-release/changelog \
            @semantic-release/git \
            @semantic-release/github \
            @semantic-release/exec \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            conventional-changelog-conventionalcommits

      - name: Verify git configuration
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Capture version before release
        id: prev-version
        run: |
          if [ -f VERSION ]; then
            PREV_VERSION=$(cat VERSION)
            echo "version=${PREV_VERSION}" >> "$GITHUB_OUTPUT"
            echo "Previous version: ${PREV_VERSION}"
          else
            echo "version=" >> "$GITHUB_OUTPUT"
            echo "No previous VERSION file found"
          fi

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: npx semantic-release

      - name: Check if new version was released
        id: check-version
        env:
          PREV_VERSION: ${{ steps.prev-version.outputs.version }}
        run: |
          if [ -f VERSION ]; then
            NEW_VERSION=$(cat VERSION)
            echo "Previous version: ${PREV_VERSION:-none}"
            echo "New version: ${NEW_VERSION}"

            if [ "${PREV_VERSION}" != "${NEW_VERSION}" ]; then
              echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
              echo "released=true" >> "$GITHUB_OUTPUT"
              echo "âœ… New version released: ${NEW_VERSION}"
            else
              echo "version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
              echo "released=false" >> "$GITHUB_OUTPUT"
              echo "â„¹ï¸ No version change (still ${NEW_VERSION})"
            fi
          else
            echo "released=false" >> "$GITHUB_OUTPUT"
            echo "âŒ No VERSION file found - no release created"
          fi

      - name: Setup Python for Galaxy publishing
        if: steps.check-version.outputs.released == 'true'
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"

      - name: Publish to Ansible Galaxy
        if: steps.check-version.outputs.released == 'true'
        env:
          GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}
        run: |
          chmod +x .github/scripts/publish-galaxy.sh
          ./.github/scripts/publish-galaxy.sh

      - name: Release Summary
        if: steps.check-version.outputs.released == 'true'
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<'EOF'
          ## ðŸŽ‰ Release Summary
        
          **Version:** ${{ steps.check-version.outputs.version }}
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
        
          ### Published To
          - âœ… GitHub Releases
          - âœ… Ansible Galaxy (trevorbenson.iso_manager)
        
          ### Links
          - [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.check-version.outputs.version }})
          - [Ansible Galaxy](https://galaxy.ansible.com/trevorbenson/iso_manager)
          - [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          EOF
